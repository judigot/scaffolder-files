import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { logger } from 'hono/logger';
import { prettyJSON } from 'hono/pretty-json';
import { hc } from 'hono/client';

// Import route modules
<@@LOOP@@ data="tables" separator="\n">import {{tableNameCamelCase}}Routes from './routes/{{tableNameCamelCaseSingular}}';</@@LOOP@@>

const app = new Hono().basePath('/api');

// Middleware
app.use('*', cors());
app.use('*', logger());
app.use('*', prettyJSON());

// Health check
app.get('/health', (c) => c.json({ status: 'ok', timestamp: new Date().toISOString() }));

// Mount routes
<@@LOOP@@ data="tables" separator="\n">app.route('/{{tableNameKebabCase}}', {{tableNameCamelCase}}Routes);</@@LOOP@@>

// Export types for RPC client
export type AppType = typeof app;

// Create typed client for use in frontend and tests
export const createClient = (baseUrl: string) => hc<AppType>(baseUrl);

// Start server
const port = Number(process.env.PORT) || 3000;

export default {
  port,
  fetch: app.fetch,
};

// For local development
if (process.env.NODE_ENV !== 'production') {
  console.log(`Server running at http://localhost:${port}`);
}
