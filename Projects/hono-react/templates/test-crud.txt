import { describe, it, expect } from 'vitest';

const BASE_URL = process.env.TEST_API_URL || 'http://localhost:3000';

/**
 * CRUD Testing Pattern: C → R → U → R → D → R
 *
 * This pattern ensures complete lifecycle testing:
 * 1. CREATE - Create a new record
 * 2. READ   - Verify the created record
 * 3. UPDATE - Modify the record
 * 4. READ   - Verify the update
 * 5. DELETE - Remove the record
 * 6. READ   - Verify deletion (404)
 */
describe('<@@>tableName.pascalCase</@@> API - CRUD Testing (C→R→U→R→D→R)', () => {
  let createdId: number;

  // Test data - using mock values for each column
  const testData = {
<@@LOOP@@ data="columnsInfo" separator=",\n"><@@IF@@ condition="is_primary_key NOT EQUAL 'true'">    <@@>value.camelCase</@@>: <@@IF@@ condition="data_type EQUALS 'string'">'test-<@@>value.camelCase</@@>'</@@IF@@><@@IF@@ condition="data_type EQUALS 'number'">1</@@IF@@><@@IF@@ condition="data_type EQUALS 'boolean'">true</@@IF@@><@@IF@@ condition="data_type EQUALS 'Date'">new Date('2024-01-01T00:00:00Z')</@@IF@@></@@IF@@></@@LOOP@@>
  };

  const updateData = {
<@@LOOP@@ data="columnsInfo" separator=",\n"><@@IF@@ condition="is_primary_key NOT EQUAL 'true'">    <@@>value.camelCase</@@>: <@@IF@@ condition="data_type EQUALS 'string'">'updated-<@@>value.camelCase</@@>'</@@IF@@><@@IF@@ condition="data_type EQUALS 'number'">2</@@IF@@><@@IF@@ condition="data_type EQUALS 'boolean'">false</@@IF@@><@@IF@@ condition="data_type EQUALS 'Date'">new Date('2024-12-31T00:00:00Z')</@@IF@@></@@IF@@></@@LOOP@@>
  };

  // 1. CREATE - Create new record
  it('should CREATE a new <@@>tableName.singular</@@>', async () => {
    const res = await fetch(`${BASE_URL}/api/<@@>tableName.kebabCase</@@>`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(testData),
    });
    expect(res.status).toBe(201);
    const data = await res.json();
    expect(data.<@@>getPrimaryKeyCamelCase()</@@>).toBeDefined();
    createdId = data.<@@>getPrimaryKeyCamelCase()</@@>;
  });

  // 2. READ - Read after create
  it('should READ the created <@@>tableName.singular</@@>', async () => {
    const res = await fetch(`${BASE_URL}/api/<@@>tableName.kebabCase</@@>/${createdId}`);
    expect(res.status).toBe(200);
    const data = await res.json();
    expect(data.<@@>getPrimaryKeyCamelCase()</@@>).toBe(createdId);
  });

  // 3. UPDATE - Update the record
  it('should UPDATE the <@@>tableName.singular</@@>', async () => {
    const res = await fetch(`${BASE_URL}/api/<@@>tableName.kebabCase</@@>/${createdId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData),
    });
    expect(res.status).toBe(200);
  });

  // 4. READ - Read after update
  it('should READ the updated <@@>tableName.singular</@@>', async () => {
    const res = await fetch(`${BASE_URL}/api/<@@>tableName.kebabCase</@@>/${createdId}`);
    expect(res.status).toBe(200);
  });

  // 5. DELETE - Delete the record
  it('should DELETE the <@@>tableName.singular</@@>', async () => {
    const res = await fetch(`${BASE_URL}/api/<@@>tableName.kebabCase</@@>/${createdId}`, {
      method: 'DELETE',
    });
    expect(res.status).toBe(200);
  });

  // 6. READ - Read after delete (should 404)
  it('should return 404 after DELETE', async () => {
    const res = await fetch(`${BASE_URL}/api/<@@>tableName.kebabCase</@@>/${createdId}`);
    expect(res.status).toBe(404);
  });
});
