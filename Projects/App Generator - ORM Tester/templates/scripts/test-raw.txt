/**
 * Test Raw SQL migrations
 * 1. Clean database
 * 2. Execute schema.sql
 * 3. Export schema to results/raw_result.json
 */

import * as fs from 'node:fs';
import * as path from 'node:path';
import { cleanDatabase, exportSchema, writeResult, getConnection } from './db-utils.ts';

const ORM_NAME = 'raw';

async function main() {
  console.log(`\n=== Testing ${ORM_NAME.toUpperCase()} SQL ===`);

  // Step 1: Clean database
  console.log('1. Cleaning database...');
  await cleanDatabase();

  // Step 2: Execute schema.sql
  console.log('2. Executing schema.sql...');
  const schemaPath = path.join(process.cwd(), 'src', 'raw', 'schema.sql');
  const schemaSql = fs.readFileSync(schemaPath, 'utf-8');

  const sql = getConnection();
  try {
    await sql.unsafe(schemaSql);
    console.log('  Schema executed successfully');
  } finally {
    await sql.end();
  }

  // Step 3: Export schema
  console.log('3. Exporting schema...');
  const result = await exportSchema(ORM_NAME);
  console.log(`  Found ${result.tables.length} tables`);

  // Step 4: Write result
  console.log('4. Writing result...');
  writeResult(result);

  console.log(`\n${ORM_NAME.toUpperCase()} test completed successfully!\n`);
}

main().catch((err) => {
  console.error(`${ORM_NAME.toUpperCase()} test failed:`, err);
  process.exit(1);
});
