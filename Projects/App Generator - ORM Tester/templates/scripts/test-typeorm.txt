/**
 * Test TypeORM migrations
 * 1. Clean database
 * 2. Run TypeORM synchronize
 * 3. Export schema to results/typeorm_result.json
 */

import 'reflect-metadata';
import { cleanDatabase, exportSchema, writeResult } from './db-utils.ts';
import { AppDataSource } from '../src/typeorm/data-source.ts';

const ORM_NAME = 'typeorm';

async function main() {
  console.log(`\n=== Testing ${ORM_NAME.toUpperCase()} ===`);

  // Step 1: Clean database
  console.log('1. Cleaning database...');
  await cleanDatabase();

  // Step 2: Initialize TypeORM (synchronize: true creates tables)
  console.log('2. Running TypeORM synchronize...');
  try {
    await AppDataSource.initialize();
    console.log('  TypeORM migration completed');
  } finally {
    if (AppDataSource.isInitialized) {
      await AppDataSource.destroy();
    }
  }

  // Step 3: Export schema
  console.log('3. Exporting schema...');
  const result = await exportSchema(ORM_NAME);
  console.log(`  Found ${result.tables.length} tables`);

  // Step 4: Write result
  console.log('4. Writing result...');
  writeResult(result);

  console.log(`\n${ORM_NAME.toUpperCase()} test completed successfully!\n`);
}

main().catch((err) => {
  console.error(`${ORM_NAME.toUpperCase()} test failed:`, err);
  process.exit(1);
});
